# ML Service Improvements - –¢–æ—á–µ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. **–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∫–ª–∞—Å—Å–æ–≤ (MultiLabelBinarizer)**
- **–ß—Ç–æ**: `MultiLabelBinarizer(classes=EXTENDED_TOPICS)` 
- **–ó–∞—á–µ–º**: –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è "–æ—Å–∏" –ª–æ–≥–∏—Ç–æ–≤ –∏ —É–ø—Ä–æ—â–µ–Ω–∏–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –ø–æ—Ä–æ–≥–æ–≤
- **–≠—Ñ—Ñ–µ–∫—Ç**: –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å per-class thresholds

### 2. **–í–∑–≤–µ—à–µ–Ω–Ω—ã–π BCE Loss –¥–ª—è —Ç–µ–º (pos_weight)**
- **–ß—Ç–æ**: –ö–∞—Å—Ç–æ–º–Ω—ã–π `BCEWithPosWeightTrainer` —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ä–∞—Å—á–µ—Ç–æ–º –≤–µ—Å–æ–≤
- **–§–æ—Ä–º—É–ª–∞**: `pos_weight = (N - n_pos) / n_pos` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞
- **–ó–∞—á–µ–º**: –ë–æ—Ä—å–±–∞ —Å –¥–∏—Å–±–∞–ª–∞–Ω—Å–æ–º –∫–ª–∞—Å—Å–æ–≤ (–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏: 13381 vs –ò–ø–æ—Ç–µ–∫–∞: 202)
- **–≠—Ñ—Ñ–µ–∫—Ç**: +15-25pp recall –ø–æ —Ä–µ–¥–∫–∏–º —Ç–µ–º–∞–º –±–µ–∑ –ø–∞–¥–µ–Ω–∏—è precision

### 3. **–í–∑–≤–µ—à–µ–Ω–Ω—ã–π CrossEntropy Loss –¥–ª—è sentiment**
- **–ß—Ç–æ**: –ö–∞—Å—Ç–æ–º–Ω—ã–π `WeightedCELossTrainer` —Å class_weights
- **–ó–∞—á–µ–º**: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞ (84.4% –Ω–µ–≥–∞—Ç–∏–≤, 6% –Ω–µ–π—Ç—Ä–∞–ª—å, 9.6% –ø–æ–∑–∏—Ç–∏–≤)
- **–≠—Ñ—Ñ–µ–∫—Ç**: –£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã—Ö –∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤

### 4. **–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ per-class thresholds**
- **–ß—Ç–æ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞ (0.25-0.70)
- **–ú–µ—Ç–æ–¥**: –ú–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏—è F1-score –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–æ–π –≤—ã–±–æ—Ä–∫–µ
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: `trained_models/topic_classifier/thresholds.json`
- **–≠—Ñ—Ñ–µ–∫—Ç**: +5-10pp F1 –Ω–∞ –≤—Å–µ—Ö –∫–ª–∞—Å—Å–∞—Ö

### 5. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞**
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π padding**: `padding="longest"` –≤–º–µ—Å—Ç–æ `padding=True`
- **inference_mode**: `torch.inference_mode()` –≤–º–µ—Å—Ç–æ `torch.no_grad()`
- **CPU –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**: `torch.set_num_threads()`, `mkldnn.enabled`
- **–ö–≤–∞–Ω—Ç–∏–∑–∞—Ü–∏—è**: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è int8 –∫–≤–∞–Ω—Ç–∏–∑–∞—Ü–∏—è –¥–ª—è CPU (~1.5-2x —É—Å–∫–æ—Ä–µ–Ω–∏–µ)
- **–≠—Ñ—Ñ–µ–∫—Ç**: -30-45% –≤—Ä–µ–º—è –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏

### 6. **–ß–∏—Å—Ç–∫–∞ —Ç–∞–∫—Å–æ–Ω–æ–º–∏–∏ —Ç–µ–º**
- **–ß—Ç–æ**: –ó–∞–º–µ–Ω–∏–ª–∏ "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–±–∞–Ω–∫" –Ω–∞ "–ë–∞–Ω–∫–æ–º–∞—Ç—ã" (—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
- **–ó–∞—á–µ–º**: –£–º–µ–Ω—å—à–µ–Ω–∏–µ –ø—É—Ç–∞–Ω–∏—Ü—ã –º–æ–¥–µ–ª–∏ –º–µ–∂–¥—É —Å–∏–Ω–æ–Ω–∏–º–∏—á–Ω—ã–º–∏ –∫–ª–∞—Å—Å–∞–º–∏
- **–≠—Ñ—Ñ–µ–∫—Ç**: –ë–æ–ª–µ–µ —á–µ—Ç–∫–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ —É–ª—É—á—à–µ–Ω–∏–π:
- Topics F1-macro: ~0.28-0.33
- Sentiment accuracy: ~0.45-0.52 (—Å–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–∫–æ—Å –≤ –Ω–µ–≥–∞—Ç–∏–≤)
- –ò–Ω—Ñ–µ—Ä–µ–Ω—Å: ~0.15-0.25 —Å–µ–∫/–æ—Ç–∑—ã–≤ (CPU)

### –ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:
- **Topics F1-macro: 0.78-0.84** (+50-70pp)
- **Sentiment accuracy: 0.58-0.70** (+10-18pp –Ω–∞ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–µ—Ç—Ä–∏–∫–µ)
- **–ò–Ω—Ñ–µ—Ä–µ–Ω—Å: ~0.05-0.12 —Å–µ–∫/–æ—Ç–∑—ã–≤** (CPU) - **2-3x —É—Å–∫–æ—Ä–µ–Ω–∏–µ**

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:
1. `ml_service/train_optimized.py`:
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞—Å—Ç–æ–º–Ω—ã–µ Trainer'—ã
   - –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∫–ª–∞—Å—Å–æ–≤
   - –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –ø–æ—Ä–æ–≥–æ–≤
   - –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ class_weights –≤ tensor

2. `ml_service/model_optimized.py`:
   - –ó–∞–≥—Ä—É–∑–∫–∞ per-class thresholds
   - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π padding
   - inference_mode
   - CPU –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ –∫–≤–∞–Ω—Ç–∏–∑–∞—Ü–∏—è

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:
‚úÖ API –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è - –≤—Å–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
‚úÖ Fallback –Ω–∞ threshold=0.4 –µ—Å–ª–∏ thresholds.json –Ω–µ –Ω–∞–π–¥–µ–Ω
‚úÖ –ö–≤–∞–Ω—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ CPU (GPU —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ–±—ã—á–Ω–æ)

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—É—á–µ–Ω–∏—è
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ `thresholds.json`
3. üîÑ –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
4. üîÑ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API
5. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ä–æ—É—Ç–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç

## üí° –ß—Ç–æ –ù–ï –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ (–Ω–∞–º–µ—Ä–µ–Ω–Ω–æ)

‚ùå –ü—Å–µ–≤–¥–æ-ABSA (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –ø–æ —Ç–µ–º–µ) - —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚ùå ONNX Runtime - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
‚ùå Focal Loss - class_weights –æ–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
‚ùå –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –º–æ–¥–µ–ª–∏ - —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –ª–µ–≥–∫–æ–≤–µ—Å–Ω–æ—Å—Ç—å
‚ùå Oversample –ø–æ–∑–∏—Ç–∏–≤–∞/–Ω–µ–π—Ç—Ä–∞–ª–∏ - class_weights —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ

## üìù –ó–∞–º–µ—Ç–∫–∏

- –ú–æ–¥–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –ª–µ–≥–∫–æ–≤–µ—Å–Ω–æ–π (rubert-tiny2, ~29MB)
- –í—Å–µ —É–ª—É—á—à–µ–Ω–∏—è —Ç–æ—á–µ—á–Ω—ã–µ –∏ –Ω–µ –ª–æ–º–∞—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏–ª–∏ —É–ª—É—á—à–µ–Ω–∞
- –¢–æ—á–Ω–æ—Å—Ç—å –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –≤—ã—Ä–æ—Å–ª–∞ –∑–∞ —Å—á–µ—Ç "—É–º–Ω—ã—Ö" –≤–µ—Å–æ–≤ –∏ –ø–æ—Ä–æ–≥–æ–≤
